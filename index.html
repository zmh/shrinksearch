<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Therapist Finder</title>
    <style>
        /* --- Theme Variables --- */
        :root,
        body[data-theme="bloomberg"] {
            --bg-color: #000000;
            --text-color: #00FF00;
            --text-color-secondary: #aaa;
            --text-color-tertiary: #ccc;
            --header-color: #FFA500;
            --label-color: #FFFF00;
            --link-color: #00FFFF;
            --border-color: #333333;
            --border-color-light: #222;
            --bg-color-dark: #0d0d0d;
            --bg-color-medium: #1a1a1a;
            --hover-bg-color: #2a2a2a;
            --scrollbar-bg: #1a1a1a;
            --scrollbar-thumb: #555;
        }

        body[data-theme="solarized-dark"] {
            --bg-color: #002b36; 
            --text-color: #839496; 
            --text-color-secondary: #586e75; 
            --text-color-tertiary: #657b83; 
            --header-color: #cb4b16; /* Orange */
            --label-color: #b58900; /* Yellow */
            --link-color: #2aa198; /* Cyan */
            --border-color: #073642;
            --border-color-light: #073642; 
            --bg-color-dark: #073642;
            --bg-color-medium: #002b36;
            --hover-bg-color: #073642;
            --scrollbar-bg: #073642;
            --scrollbar-thumb: #586e75;
        }

        body[data-theme="solarized-light"] {
            --bg-color: #fdf6e3;
            --text-color: #657b83;
            --text-color-secondary: #93a1a1;
            --text-color-tertiary: #839496;
            --header-color: #cb4b16; /* Orange */
            --label-color: #b58900; /* Yellow */
            --link-color: #2aa198; /* Cyan */
            --border-color: #eee8d5;
            --border-color-light: #eee8d5;
            --bg-color-dark: #eee8d5;
            --bg-color-medium: #fdf6e3;
            --hover-bg-color: #eee8d5;
            --scrollbar-bg: #eee8d5;
            --scrollbar-thumb: #93a1a1;
        }
        /* --- End Theme Variables --- */

        /* Apply Variables */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            margin: 0;
            padding: 10px;
        }
        /* Apply variables to scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scrollbar-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--label-color); /* Highlight on hover */
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls label {
            color: var(--label-color);
        }
        .controls input[type="text"],
        .controls select {
            background-color: var(--bg-color-medium);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px;
            font-family: inherit;
            font-size: inherit;
        }
        .controls input[type="text"]::placeholder {
            color: var(--text-color-secondary);
        }
        #dataTableContainer {
            flex: 3; /* Takes up 3 parts of space */
            overflow: auto; /* Scrollbars for both x and y */
            border: 1px solid var(--border-color);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color);
            font-size: 12px; /* Smaller font for higher density */
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 4px 6px;
            text-align: left;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            max-width: 200px; /* Limit max width of columns */
        }
        th {
            background-color: var(--bg-color-medium);
            color: var(--header-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tbody tr:nth-child(even) {
            background-color: var(--bg-color-dark);
        }
        tbody tr:hover,
        tbody tr.highlighted-row {
            background-color: var(--hover-bg-color);
            cursor: default; /* Indicate hover/selection */
        }
        td a {
             color: var(--link-color);
             text-decoration: none;
        }
        td a:hover {
             text-decoration: underline;
        }
        #status {
            color: var(--header-color); /* Use header color for status/errors */
            margin-top: 10px;
        }
        #loading {
            color: var(--label-color);
        }

        /* New layout styles */
        #mainContent {
            display: flex;
            gap: 10px;
            /* Calculate height minus controls/header - adjust as needed */
            height: calc(100vh - 120px);
        }
        #previewPane {
            flex: 1; /* Takes up 1 part of space */
            border: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto; /* Only vertical scroll */
            background-color: var(--bg-color-dark);
            font-size: 11px; /* Even smaller for density */
        }
        #previewPane h3 {
            color: var(--header-color);
            margin-top: 0;
            margin-bottom: 2px; /* Reduced margin */
            font-size: 13px;
            padding-bottom: 0;
        }
        #previewPane .preview-degrees {
            font-size: 10px;
            color: var(--text-color-tertiary);
            margin-bottom: 5px;
        }
        #previewPane .preview-short-desc {
            font-size: 10px;
            color: var(--text-color-tertiary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            padding-top: 5px;
            border-bottom: 1px dotted var(--border-color-light);
            white-space: normal; /* Allow wrapping */
        }
        #previewPane strong.field-key {
            color: var(--label-color);
            display: block; /* Key on its own line */
            margin-bottom: 3px;
            font-size: 11px;
        }
        #previewPane .field-value {
            display: block; /* Value below key */
            padding-left: 5px; /* Indent value slightly */
            font-size: 10px;
            color: var(--text-color);
            word-wrap: break-word; /* Wrap long values */
        }
        #previewPane .field-value a {
           color: var(--link-color);
        }

        /* Theme Picker Styles */
        #themePicker {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .theme-square {
            width: 20px;
            height: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
        }
        .theme-square:hover {
             transform: scale(1.1);
        }
        .theme-square.active {
            border: 2px solid var(--link-color); /* Highlight active theme */
        }

        /* Responsive stacking for smaller screens */
        @media (max-width: 800px) {
            #mainContent {
                flex-direction: column;
                height: auto; /* Allow content to dictate height */
            }
            #dataTableContainer {
                flex: none; /* Reset flex */
                width: 100%;
                max-height: 50vh; /* Limit table height on mobile */
            }
            #previewPane {
                flex: none; /* Reset flex */
                width: auto; /* Take available width */
                margin-top: 10px;
                max-height: 40vh;
            }
        }
    </style>
</head>
<body>

    <!-- Theme Picker -->
    <div id="themePicker">
        <span class="theme-square" data-set-theme="bloomberg" title="Bloomberg Theme" style="background-color: #000000;"></span>
        <span class="theme-square" data-set-theme="solarized-dark" title="Solarized Dark" style="background-color: #002b36;"></span>
        <span class="theme-square" data-set-theme="solarized-light" title="Solarized Light" style="background-color: #fdf6e3;"></span>
    </div>

    <h1>NYC Therapist Finder</h1>

    <div class="controls">
        <label for="search">Search:</label>
        <input type="text" id="search" placeholder="Search any field...">

        <label for="newClientsFilter">New Clients:</label>
        <select id="newClientsFilter">
            <option value="all">All</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
            <option value="Waitlist">Waitlist</option>
            <!-- Options will be populated dynamically if needed -->
        </select>

        <!-- Add more filters here as needed -->
        <span id="rowCount"></span>
    </div>

    <div id="status"></div>
    <div id="loading">Loading data...</div> <!-- Visible initially -->

    <!-- New main content wrapper -->
    <div id="mainContent">
        <div id="dataTableContainer"> <!-- Existing table container -->
            <table id="therapistTable">
                <thead>
                    <!-- Headers will be populated dynamically -->
                </thead>
                <tbody>
                    <!-- Data rows will be populated dynamically -->
                </tbody>
            </table>
        </div>

        <!-- New preview pane -->
        <div id="previewPane">
            <h3>Details</h3>
            <div id="previewContent">
                <p>Hover over a row in the table to see details here.</p>
            </div>
        </div>
    </div>

    <script>
        const jsonDataUrl = 'nyc_therapists.json';
        const tableBody = document.querySelector('#therapistTable tbody');
        const tableHead = document.querySelector('#therapistTable thead');
        const searchInput = document.getElementById('search');
        const newClientsFilter = document.getElementById('newClientsFilter');
        const statusDiv = document.getElementById('status');
        const loadingDiv = document.getElementById('loading');
        const rowCountSpan = document.getElementById('rowCount');
        const previewContentDiv = document.getElementById('previewContent');
        const themePicker = document.getElementById('themePicker'); // Get theme picker container

        let allData = [];
        let headers = [];

        // Debounce function
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function renderTable(dataToRender) {
            tableBody.innerHTML = ''; // Clear existing rows
            let currentHighlightedRow = null; // Keep track of highlighted row

            if (dataToRender.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="' + headers.length + '">No matching therapists found.</td></tr>';
                rowCountSpan.textContent = 'Showing 0 therapists';
                return;
            }

            dataToRender.forEach((row, dataIndex) => { // Get index relative to filtered data
                const tr = document.createElement('tr');
                tr.dataset.index = allData.findIndex(item => item === row); // Store original index from allData

                headers.forEach((header) => {
                    const td = document.createElement('td');
                    let cellValue = row[header] !== undefined ? row[header] : '';

                    // Make website and phone clickable
                    if (header === 'website' && cellValue) {
                        const link = document.createElement('a');
                        link.href = cellValue.startsWith('http') ? cellValue : 'http://' + cellValue;
                        link.textContent = cellValue;
                        link.target = '_blank'; // Open in new tab
                        td.appendChild(link);
                    } else if (header === 'phone' && cellValue) {
                        const link = document.createElement('a');
                        link.href = `tel:${cellValue.replace(/\D/g,'')}`; // Create tel link, remove non-digits
                        link.textContent = cellValue;
                        td.appendChild(link);
                    } else {
                        td.textContent = cellValue;
                        td.title = cellValue; // Show full text on hover
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            rowCountSpan.textContent = `Showing ${dataToRender.length} of ${allData.length} therapists`;

            // Add hover listeners using event delegation after rows are added
            tableBody.removeEventListener('mouseover', handleRowHover);
            tableBody.addEventListener('mouseover', handleRowHover);

            // Clear preview when table re-renders
            clearPreview();
        }

        // --- New functions for preview --- 
        function clearPreview() {
            previewContentDiv.innerHTML = '<p>Hover over a row in the table to see details here.</p>';
        }

        function updatePreview(originalIndex) {
            if (originalIndex < 0 || originalIndex >= allData.length) {
                clearPreview();
                return;
            }
            const therapist = allData[originalIndex];
            previewContentDiv.innerHTML = ''; // Clear previous

            // --- Create Header --- 
            // Name
            if (therapist.name) {
                const nameH3 = document.createElement('h3');
                nameH3.textContent = therapist.name;
                previewContentDiv.appendChild(nameH3);
            }

            // Degrees
            if (therapist.degrees) {
                const degreesP = document.createElement('p');
                degreesP.className = 'preview-degrees';
                degreesP.textContent = therapist.degrees;
                previewContentDiv.appendChild(degreesP);
            }

            // Formatted Short Description Text
            if (therapist.all_short_descriptions_text) {
                const descP = document.createElement('p');
                descP.className = 'preview-short-desc';
                // Replace double spaces with <br> for line breaks in HTML
                const formattedDesc = therapist.all_short_descriptions_text.replace(/  +/g, '<br>');
                descP.innerHTML = formattedDesc; // Use innerHTML to render breaks
                previewContentDiv.appendChild(descP);
            }
            // --- End Header --- 

            // --- Create Fields --- 
            headers.forEach(header => {
                // Skip fields already shown in header
                if (header === 'name' || header === 'degrees' || header === 'image_url' || header === 'all_short_descriptions_text') {
                    return; 
                }

                const value = therapist[header] !== undefined ? therapist[header] : 'N/A';
                if (value && value !== 'N/A') { // Only show fields with values
                    const fieldBlock = document.createElement('div');
                    fieldBlock.className = 'field-block';

                    const keyStrong = document.createElement('strong');
                    keyStrong.className = 'field-key';
                    // Format header: replace underscores, capitalize
                    keyStrong.textContent = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    fieldBlock.appendChild(keyStrong);
                    
                    const valueDiv = document.createElement('div');
                    valueDiv.className = 'field-value';

                    // Handle links in preview
                    if (header === 'website' && value) {
                        const link = document.createElement('a');
                        link.href = value.startsWith('http') ? value : 'http://' + value;
                        link.textContent = value;
                        link.target = '_blank'; 
                        valueDiv.appendChild(link);
                    } else if (header === 'phone' && value) {
                        const link = document.createElement('a');
                        link.href = `tel:${value.replace(/\D/g,'')}`;
                        link.textContent = value;
                        valueDiv.appendChild(link);
                    } else {
                        valueDiv.appendChild(document.createTextNode(value));
                    }
                    fieldBlock.appendChild(valueDiv);
                    previewContentDiv.appendChild(fieldBlock);
                }
            });
            // --- End Fields --- 
        }

        function handleRowHover(event) {
            const targetRow = event.target.closest('tr');
            if (!targetRow || !tableBody.contains(targetRow)) return; // Ensure it's a row within our tbody

            // Remove highlight from previously hovered row
            const highlighted = tableBody.querySelector('.highlighted-row');
            if (highlighted) {
                highlighted.classList.remove('highlighted-row');
            }

            // Add highlight to current row
            targetRow.classList.add('highlighted-row');

            const originalIndex = parseInt(targetRow.dataset.index, 10);
            if (!isNaN(originalIndex)) {
                updatePreview(originalIndex);
            }
        }
        // --- End new functions --- 

        function filterData() {
            const searchTerm = searchInput.value.toLowerCase();
            const newClientFilterValue = newClientsFilter.value;

            const filteredData = allData.filter(row => {
                // Filter by 'new_clients' status
                let newClientMatch = true;
                if (newClientFilterValue !== 'all' && row.hasOwnProperty('new_clients')) {
                    const clientStatus = row['new_clients'] || '';
                    // Basic matching - might need refinement based on actual data variations
                    if (newClientFilterValue === 'Yes') {
                        newClientMatch = clientStatus.toLowerCase().includes('yes') || clientStatus.toLowerCase().includes('accepting'); // Allow variations
                    } else if (newClientFilterValue === 'No') {
                        newClientMatch = clientStatus.toLowerCase().includes('no') || clientStatus.toLowerCase().includes('not accepting');
                    } else if (newClientFilterValue === 'Waitlist') {
                        newClientMatch = clientStatus.toLowerCase().includes('waitlist');
                    }
                }

                // Filter by search term (searches all fields)
                let searchMatch = false;
                if (!searchTerm) {
                    searchMatch = true; // No search term means match all
                } else {
                    searchMatch = Object.values(row).some(value =>
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                }

                return newClientMatch && searchMatch;
            });

            renderTable(filteredData);
        }

        async function loadAndDisplayData() {
            try {
                statusDiv.textContent = '';
                loadingDiv.style.display = 'block';
                tableBody.innerHTML = '';
                tableHead.innerHTML = '';

                const response = await fetch(jsonDataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allData = await response.json();

                if (!Array.isArray(allData) || allData.length === 0) {
                    throw new Error('Failed to parse JSON, JSON is empty, or not an array.');
                }

                // Determine headers from the keys of the first object
                headers = Object.keys(allData[0]);

                // Populate table headers
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Format header
                    tr.appendChild(th);
                });
                tableHead.appendChild(tr);

                // Initial render
                renderTable(allData);

                // Create a debounced version of filterData
                const debouncedFilterData = debounce(filterData, 300); // 300ms delay

                // Add event listeners for controls (only once after data load)
                searchInput.removeEventListener('input', debouncedFilterData); // Use debounced version
                searchInput.addEventListener('input', debouncedFilterData); // Use debounced version
                newClientsFilter.removeEventListener('change', filterData); // Filter doesn't need debounce
                newClientsFilter.addEventListener('change', filterData); // Filter doesn't need debounce

            } catch (error) {
                console.error('Error loading or processing data:', error);
                statusDiv.textContent = `Error: ${error.message}. Please ensure '${jsonDataUrl}' is in the same directory, accessible by the server, and is valid JSON.`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // --- Theme Switching Logic ---
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('therapistFinderTheme', theme);

            // Update active class on picker
            const squares = themePicker.querySelectorAll('.theme-square');
            squares.forEach(square => {
                if (square.dataset.setTheme === theme) {
                    square.classList.add('active');
                } else {
                    square.classList.remove('active');
                }
            });
        }

        themePicker.addEventListener('click', (event) => {
            if (event.target.classList.contains('theme-square')) {
                const theme = event.target.dataset.setTheme;
                if (theme) {
                    applyTheme(theme);
                }
            }
        });

        // Load saved theme on startup
        const savedTheme = localStorage.getItem('therapistFinderTheme') || 'bloomberg'; // Default to bloomberg
        applyTheme(savedTheme);
        // --- End Theme Switching Logic ---

        // Initial load triggered automatically
        loadAndDisplayData();
    </script>

</body>
</html>
