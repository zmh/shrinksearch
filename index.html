<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Therapist Finder</title>
    <style>
        /* --- Theme Variables --- */
        :root,
        body[data-theme="bloomberg"] {
            --bg-color: #000000;
            --text-color: #00FF00;
            --text-color-secondary: #aaa;
            --text-color-tertiary: #ccc;
            --header-color: #FFA500;
            --label-color: #FFFF00;
            --link-color: #00FFFF;
            --border-color: #333333;
            --border-color-light: #222;
            --bg-color-dark: #0d0d0d;
            --bg-color-medium: #1a1a1a;
            --hover-bg-color: #2a2a2a;
            --scrollbar-bg: #1a1a1a;
            --scrollbar-thumb: #555;
            --highlight-bg-color: #FFFF00; /* Yellow background */
            --highlight-text-color: #000000; /* Black text */
            --star-color: #dc322f; /* Solarized Red */
            --star-color-inactive: var(--text-color-secondary);
        }

        body[data-theme="solarized-dark"] {
            --bg-color: #002b36; 
            --text-color: #93a1a1; /* Brighter Gray for contrast */
            --text-color-secondary: #586e75; 
            --text-color-tertiary: #657b83; 
            --header-color: #cb4b16; /* Orange */
            --label-color: #b58900; /* Yellow */
            --link-color: #2aa198; /* Cyan */
            --border-color: #073642;
            --border-color-light: #073642; 
            --bg-color-dark: #073642;
            --bg-color-medium: #002b36;
            --hover-bg-color: #073642;
            --scrollbar-bg: #073642;
            --scrollbar-thumb: #586e75;
            --highlight-bg-color: #b58900; /* Solarized Yellow background */
            --highlight-text-color: #002b36; /* Solarized Base background for text */
            --star-color: #dc322f; /* Solarized Red */
            --star-color-inactive: var(--text-color-secondary);
        }

        body[data-theme="solarized-light"] {
            --bg-color: #fdf6e3;
            --text-color: #586e75; /* Darker Gray for contrast */
            --text-color-secondary: #93a1a1;
            --text-color-tertiary: #839496;
            --header-color: #cb4b16; /* Orange */
            --label-color: #b58900; /* Yellow */
            --link-color: #2aa198; /* Cyan */
            --border-color: #eee8d5;
            --border-color-light: #eee8d5;
            --bg-color-dark: #eee8d5;
            --bg-color-medium: #fdf6e3;
            --hover-bg-color: #eee8d5;
            --scrollbar-bg: #eee8d5;
            --scrollbar-thumb: #93a1a1;
            --highlight-bg-color: #b58900; /* Solarized Yellow background */
            --highlight-text-color: #fdf6e3; /* Solarized Base background for text */
            --star-color: #dc322f; /* Solarized Red */
            --star-color-inactive: var(--text-color-secondary);
        }
        /* --- End Theme Variables --- */

        /* Apply Variables */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            margin: 0;
            padding: 10px;
        }
        /* Apply variables to scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--scrollbar-bg);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--label-color); /* Highlight on hover */
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls label {
            color: var(--label-color);
        }
        .controls input[type="text"],
        .controls select {
            background-color: var(--bg-color-medium);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px;
            font-family: inherit;
            font-size: inherit;
        }
        .controls input[type="text"]::placeholder {
            color: var(--text-color-secondary);
        }
        #dataTableContainer {
            flex: 3; /* Takes up 3 parts of space */
            overflow: auto; /* Scrollbars for both x and y */
            border: 1px solid var(--border-color);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--border-color);
            font-size: 12px; /* Smaller font for higher density */
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 4px 6px;
            text-align: left;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden;
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            max-width: 200px; /* Limit max width of columns */
        }
        th {
            background-color: var(--bg-color-medium);
            color: var(--header-color);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tbody tr:nth-child(even) {
            background-color: var(--bg-color-dark);
        }
        tbody tr:hover,
        tbody tr.highlighted-row {
            background-color: var(--hover-bg-color);
            cursor: default; /* Indicate hover/selection */
        }
        td a {
             color: var(--link-color);
             text-decoration: none;
        }
        td a:hover {
             text-decoration: underline;
        }
        #status {
            color: var(--header-color); /* Use header color for status/errors */
            margin-top: 10px;
        }
        #loading {
            color: var(--label-color);
        }

        /* New layout styles */
        #mainContent {
            display: flex;
            gap: 10px;
            /* Calculate height minus controls/header - adjust as needed */
            height: calc(100vh - 120px);
        }
        #previewPane {
            flex: 1; /* Takes up 1 part of space */
            border: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto; /* Only vertical scroll */
            background-color: var(--bg-color-dark);
            font-size: 11px; /* Even smaller for density */
        }
        #previewPane h3 {
            color: var(--header-color);
            margin-top: 0;
            margin-bottom: 1px; /* Further reduced margin */
            font-size: 13px;
            padding-bottom: 0;
        }
        #previewPane .preview-degrees {
            font-size: 10px;
            color: var(--text-color-tertiary);
            margin-bottom: 3px; /* Reduced margin */
        }
        #previewPane .preview-short-desc {
            font-size: 10px;
            color: var(--text-color-tertiary);
            margin-bottom: 8px; /* Spacing below text */
            padding-bottom: 8px; /* Spacing below text before rule */
            padding-top: 4px; /* Spacing above text */
            border-bottom: 1px dotted var(--border-color-light); /* Add rule back here */
            white-space: normal; /* Allow wrapping */
        }
        #previewPane div.field-block {
            margin-bottom: 6px; /* Reduced space between field blocks */
        }
        #previewPane strong.field-key {
            color: var(--label-color);
            display: block; /* Key on its own line */
            margin-bottom: 3px;
            font-size: 11px;
        }
        #previewPane .field-value {
            display: block; /* Value below key */
            font-size: 10px;
            color: var(--text-color);
            word-wrap: break-word; /* Wrap long values */
            margin-bottom: 2px; /* Small space below value before next key */
        }
        #previewPane .field-value a {
           color: var(--link-color);
        }

        /* Highlight Style */
        .search-highlight {
            background-color: var(--highlight-bg-color);
            color: var(--highlight-text-color);
            padding: 0 2px; /* Small padding */
            border-radius: 2px;
        }

        /* Favorite Star Styles */
        .favorite-star {
            cursor: pointer;
            font-size: 16px; /* Make stars noticeable */
            color: var(--star-color-inactive);
            user-select: none; /* Prevent text selection */
            display: inline-block; /* Ensure proper spacing/alignment */
            min-width: 1em; /* Ensure consistent width */
            text-align: center;
            transition: color 0.2s, transform 0.1s;
        }
        .favorite-star:hover {
            transform: scale(1.2);
        }
        .favorite-star.is-favorite {
            color: var(--star-color);
        }
        #previewPane .favorite-star {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px; /* Larger star in preview */
        }

        /* Theme Picker Styles */
        #themePicker {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }
        .theme-square {
            width: 20px;
            height: 20px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
        }
        .theme-square:hover {
             transform: scale(1.1);
        }
        .theme-square.active {
            border: 2px solid var(--link-color); /* Highlight active theme */
        }

        /* Style Favorites Button like text */
        #favoritesFilterBtn {
            background: none;
            border: none;
            padding: 0;
            margin: 0 10px; /* Match spacing */
            font: inherit; /* Use body font */
            color: var(--label-color); /* Use label color */
            cursor: pointer;
            text-decoration: none; /* Remove underline if any */
            vertical-align: baseline;
        }
        #favoritesFilterBtn:hover {
            text-decoration: underline;
        }
        #favoritesFilterBtn.filter-active { /* Use a class for active state */
             font-weight: bold;
             color: var(--star-color); /* Use star color */
        }

        /* Responsive stacking for smaller screens */
        @media (max-width: 800px) {
            #mainContent {
                flex-direction: column;
                height: auto; /* Allow content to dictate height */
            }
            #dataTableContainer {
                flex: none; /* Reset flex */
                width: 100%;
                max-height: 50vh; /* Limit table height on mobile */
            }
            #previewPane {
                flex: none; /* Reset flex */
                width: auto; /* Take available width */
                margin-top: 10px;
                max-height: 40vh;
            }
        }
    </style>
</head>
<body>

    <!-- Theme Picker -->
    <div id="themePicker">
        <span class="theme-square" data-set-theme="bloomberg" title="Bloomberg Theme" style="background-color: #000000;"></span>
        <span class="theme-square" data-set-theme="solarized-dark" title="Solarized Dark" style="background-color: #002b36;"></span>
        <span class="theme-square" data-set-theme="solarized-light" title="Solarized Light" style="background-color: #fdf6e3;"></span>
    </div>

    <h1>NYC Therapist Finder</h1>

    <div class="controls">
        <label for="searchInput">Search:</label>
        <input type="text" id="searchInput" placeholder="Type to search all fields...">

        <label for="newClientsSelect">New Clients:</label>
        <select id="newClientsSelect">
            <option value="any">Any</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
        </select>

        <button id="favoritesFilterBtn">Favorites (0)</button> <!-- Favorites Button -->

        <span id="rowCountStatus" style="margin-left: auto;">Rows: <span id="rowCount">0</span></span>
    </div>

    <div id="status"></div>
    <div id="loading">Loading data...</div> <!-- Visible initially -->

    <!-- New main content wrapper -->
    <div id="mainContent">
        <div id="dataTableContainer"> <!-- Existing table container -->
            <table id="therapistTable">
                <thead>
                    <!-- Headers will be generated by JS -->
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- New preview pane -->
        <div id="previewPane">
            <span class="favorite-star" id="previewStar" title="Toggle Favorite">☆</span> <!-- Star in Preview -->
            <div id="previewContent">
                <!-- Content is dynamically generated -->
            </div>
        </div>
    </div>

    <script>
        const jsonDataUrl = 'nyc_therapists.json';
        const tableBody = document.querySelector('#therapistTable tbody');
        const tableHead = document.querySelector('#therapistTable thead');
        const searchInput = document.getElementById('searchInput');
        const newClientsSelect = document.getElementById('newClientsSelect');
        const statusDiv = document.getElementById('status');
        const loadingDiv = document.getElementById('loading');
        const rowCountSpan = document.getElementById('rowCount');
        const previewContentDiv = document.getElementById('previewContent');
        const themePicker = document.getElementById('themePicker'); // Get theme picker container

        let allData = [];
        let headers = [];
        let currentSort = { column: null, direction: 'asc' };
        let currentHighlightedRow = null;
        let searchDebounceTimeout = null;
        let currentSearchTerm = ''; // Store the current search term
        let favorites = new Set(); // Store originalIndex of favorites
        let showOnlyFavorites = false; // Flag for filtering

        // Debounce function
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // --- Favorite Management --- 
        function loadFavorites() {
            const storedFavorites = localStorage.getItem('therapistFavorites');
            if (storedFavorites) {
                try {
                    const parsed = JSON.parse(storedFavorites);
                    // Ensure it's an array of numbers before creating Set
                    if (Array.isArray(parsed) && parsed.every(item => typeof item === 'number')) {
                        favorites = new Set(parsed);
                    } else {
                        console.error("Invalid favorites data in localStorage");
                        favorites = new Set(); 
                        localStorage.removeItem('therapistFavorites'); // Clear invalid data
                    }
                } catch (e) {
                    console.error("Error parsing favorites from localStorage:", e);
                    favorites = new Set(); // Reset on error
                    localStorage.removeItem('therapistFavorites');
                }
            }
            updateFavoritesButton();
        }

        function saveFavorites() {
            // Convert Set to Array for JSON serialization
            localStorage.setItem('therapistFavorites', JSON.stringify(Array.from(favorites)));
        }

        function isFavorite(originalIndex) {
             return favorites.has(originalIndex);
        }

        function toggleFavorite(originalIndex) {
            if (favorites.has(originalIndex)) {
                favorites.delete(originalIndex);
            } else {
                favorites.add(originalIndex);
            }
            saveFavorites();
            updateFavoritesButton();
            // Refresh table to update star state potentially
            displayData(); 
             // Update preview if the toggled item is currently shown
            const currentPreviewIndex = parseInt(previewContentDiv.dataset.originalIndex, 10);
            if (!isNaN(currentPreviewIndex) && currentPreviewIndex === originalIndex) {
                 updatePreviewStar(originalIndex);
            }
        }

        function updateFavoritesButton() {
            const btn = document.getElementById('favoritesFilterBtn');
            const count = favorites.size;
            btn.textContent = `Favorites (${count})`;
            if (showOnlyFavorites) {
                 btn.classList.add('filter-active');
            } else {
                 btn.classList.remove('filter-active');
            }
        }

        // --- Data Loading and Parsing ---
        async function loadAndDisplayData() {
            try {
                statusDiv.textContent = '';
                loadingDiv.style.display = 'block';
                tableBody.innerHTML = '';
                tableHead.innerHTML = '';

                const response = await fetch(jsonDataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allData = await response.json();

                if (!Array.isArray(allData) || allData.length === 0) {
                    throw new Error('Failed to parse JSON, JSON is empty, or not an array.');
                }

                // Determine headers from the keys of the first object
                headers = Object.keys(allData[0]);

                // Populate table headers
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Format header
                    tr.appendChild(th);
                });
                tableHead.appendChild(tr);

                 // Add Fav column header
                 const favTh = document.createElement('th');
                 favTh.textContent = 'Fav';
                 tr.insertBefore(favTh, tr.firstChild); // Add to the beginning

                // Initial render
                displayData();

                // Create a debounced version of filterData
                const debouncedDisplayData = debounce(displayData, 300); // 300ms delay

                // Add event listeners for controls (only once after data load)
                searchInput.removeEventListener('input', debouncedDisplayData); // Use debounced version
                searchInput.addEventListener('input', debouncedDisplayData); // Use debounced version
                newClientsSelect.removeEventListener('change', displayData); // Filter doesn't need debounce
                newClientsSelect.addEventListener('change', displayData); // Filter doesn't need debounce

            } catch (error) {
                console.error('Error loading or processing data:', error);
                statusDiv.textContent = `Error: ${error.message}. Please ensure '${jsonDataUrl}' is in the same directory, accessible by the server, and is valid JSON.`;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // --- Display Logic --- 
        function displayData() {
            const tbody = document.getElementById('therapistTable').querySelector('tbody');
            tbody.innerHTML = ''; // Clear existing rows
            tableHead.innerHTML = ''; // Clear existing header
            rowCountSpan.textContent = '0';
            clearPreview();

            if (!allData || allData.length === 0) {
                return; // No data to display
            }

            let dataToDisplay = allData;

            // Apply Favorites Filter First
            if (showOnlyFavorites) {
                dataToDisplay = allData.filter(item => favorites.has(item.originalIndex));
            }

            // Apply Search and 'New Clients' filters (if not showing only favorites)
            if (!showOnlyFavorites) {
                 const searchTerm = searchInput.value.toLowerCase();
                 const newClientsFilter = newClientsSelect.value;

                 if (searchTerm || newClientsFilter !== 'any') {
                     dataToDisplay = dataToDisplay.filter(item => {
                         let newClientMatch = true;
                         if (newClientsFilter === 'yes') {
                             newClientMatch = item.new_clients === true || String(item.new_clients).toLowerCase() === 'yes';
                         } else if (newClientsFilter === 'no') {
                             newClientMatch = item.new_clients === false || String(item.new_clients).toLowerCase() === 'no' || !item.new_clients;
                         }

                         if (!newClientMatch) return false;

                         if (searchTerm) {
                              return Object.values(item).some(value => 
                                   value !== null && value !== undefined && String(value).toLowerCase().includes(searchTerm)
                              );
                         }
                         return true; // Only New Client filter applied
                    });
                 }
            }
            
            // Apply Sorting (using the headers from the first item of original data)
             if (currentSort.column && headers.includes(currentSort.column)) {
                dataToDisplay.sort((a, b) => {
                    const aValue = a[currentSort.column];
                    const bValue = b[currentSort.column];
                    if (aValue < bValue) {
                        return currentSort.direction === 'asc' ? -1 : 1;
                    } else if (aValue > bValue) {
                        return currentSort.direction === 'asc' ? 1 : -1;
                    } else {
                        return 0;
                    }
                });
            }

            // Populate table headers
            const tr = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Format header
                tr.appendChild(th);
            });
            tableHead.appendChild(tr);

             // Add Fav column header
             const favTh = document.createElement('th');
             favTh.textContent = 'Fav';
             tr.insertBefore(favTh, tr.firstChild); // Add to the beginning

            // --- Create Table Rows --- 
            dataToDisplay.forEach((item, index) => {
                const rowTr = document.createElement('tr');
                rowTr.dataset.index = index; // Store index for toggle logic

                // Add Fav Star Cell
                const favTd = document.createElement('td');
                const starSpan = document.createElement('span');
                starSpan.className = 'favorite-star';
                starSpan.innerHTML = isFavorite(index) ? '★' : '☆';
                starSpan.title = 'Toggle Favorite';
                starSpan.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent row hover/click if needed
                    toggleFavorite(index);
                    // Update this specific star immediately
                    starSpan.innerHTML = isFavorite(index) ? '★' : '☆';
                    starSpan.classList.toggle('is-favorite', isFavorite(index));
                });
                if(isFavorite(index)) starSpan.classList.add('is-favorite');
                favTd.appendChild(starSpan);
                rowTr.appendChild(favTd); // Add to the beginning

                headers.forEach(header => {
                    const td = document.createElement('td');
                    const value = item[header] !== undefined ? item[header] : '';
                     // Apply highlighting only if we are NOT showing just favorites (search term relevant)
                    const displayValue = !showOnlyFavorites ? highlightText(value, currentSearchTerm) : value;

                    if (header === 'website' && value) {
                        const link = document.createElement('a');
                        link.href = value.startsWith('http') ? value : 'http://' + value;
                        link.textContent = value;
                        link.target = '_blank'; // Open in new tab
                        td.appendChild(link);
                    } else if (header === 'phone' && value) {
                        const link = document.createElement('a');
                        link.href = `tel:${value.replace(/\D/g,'')}`; // Create tel link, remove non-digits
                        link.textContent = value;
                        td.appendChild(link);
                    } else {
                        td.textContent = displayValue;
                        td.title = value; // Show full text on hover
                    }
                    rowTr.appendChild(td);
                });
                tbody.appendChild(rowTr);
            });

            rowCountSpan.textContent = dataToDisplay.length;
        }

        // --- New functions for preview --- 
        function clearPreview() {
            previewContentDiv.innerHTML = ''; // Clear previous
        }

        // Function to highlight search term in text
        function highlightText(text, searchTerm) {
            if (!searchTerm || !text) {
                return text; // Return original text if no search term or text
            }
            // Escape special regex characters in the search term
            const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(escapedSearchTerm, 'gi'); // Case-insensitive, global
            // Ensure text is treated as a string
            const textString = String(text);
            return textString.replace(regex, match => `<span class="search-highlight">${match}</span>`);
        }

        function updatePreview(originalIndex) {
            if (originalIndex === null || originalIndex < 0 || originalIndex >= allData.length) {
                clearPreview();
                return;
            }
            const therapist = allData[originalIndex];
            previewContentDiv.innerHTML = ''; // Clear previous

            // --- Create Header --- 
            // Name
            if (therapist.name) {
                const nameH3 = document.createElement('h3');
                nameH3.innerHTML = highlightText(therapist.name, currentSearchTerm);
                previewContentDiv.appendChild(nameH3);
            }

            // Degrees
            if (therapist.degrees) {
                 const degreesP = document.createElement('p');
                 degreesP.className = 'preview-degrees';
                 degreesP.innerHTML = highlightText(therapist.degrees, currentSearchTerm);
                 previewContentDiv.appendChild(degreesP);
            }

            // Formatted Short Description Text
            if (therapist.all_short_descriptions_text) {
                const descP = document.createElement('p');
                descP.className = 'preview-short-desc';
                // Refined formatting: Replace $ with <br>$, then replace 2+ spaces with <br>
                let formattedDesc = String(therapist.all_short_descriptions_text || ''); // Ensure it's a string
                formattedDesc = formattedDesc.replace(/\$/g, '<br>$'); // Add break before dollar signs
                formattedDesc = formattedDesc.replace(/ {2,}/g, '<br>'); // Replace 2+ spaces with a break
                formattedDesc = formattedDesc.replace(/^<br>|<br>$/g, ''); // Trim leading/trailing breaks if any

                descP.innerHTML = highlightText(formattedDesc.trim(), currentSearchTerm); // Highlight after formatting and trimming
                previewContentDiv.appendChild(descP);
            }
            // --- End Header --- 

            // --- Create Fields --- 
            headers.forEach(header => {
                // Skip fields already shown in header
                if (header === 'name' || header === 'degrees' || header === 'image_url' || header === 'all_short_descriptions_text') {
                    return; 
                }

                const value = therapist[header] !== undefined ? therapist[header] : 'N/A';
                if (value && value !== 'N/A') { // Only show fields with values
                    const fieldBlock = document.createElement('div');
                    fieldBlock.className = 'field-block';

                    const strong = document.createElement('strong');
                    strong.className = 'field-key';
                    // No need to highlight keys, usually?
                    strong.textContent = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Format header
                    fieldBlock.appendChild(strong);

                    const span = document.createElement('span');
                    span.className = 'field-value';
                    span.innerHTML = highlightText(value, currentSearchTerm);
                    fieldBlock.appendChild(span);
                    previewContentDiv.appendChild(fieldBlock);
                }
            });
            // --- End Fields --- 
        }

        function updatePreviewStar(originalIndex) {
             const star = document.getElementById('previewStar');
             if (!star) return;
             const isFav = isFavorite(originalIndex);
             star.innerHTML = isFav ? '★' : '☆';
             star.classList.toggle('is-favorite', isFav);
             // Ensure listener is attached (or re-attached if preview is recreated)
             star.onclick = (e) => { 
                 e.stopPropagation();
                 toggleFavorite(originalIndex);
             }; 
        }

        function handleRowHover(event) {
            const targetRow = event.target.closest('tr');
            if (!targetRow || !tableBody.contains(targetRow)) return; // Ensure it's a row within our tbody

            // Remove highlight from previously hovered row
            const highlighted = tableBody.querySelector('.highlighted-row');
            if (highlighted) {
                highlighted.classList.remove('highlighted-row');
            }

            // Add highlight to current row
            targetRow.classList.add('highlighted-row');

            const originalIndex = parseInt(targetRow.dataset.index, 10);
            if (!isNaN(originalIndex)) {
                updatePreview(originalIndex);
            }
        }

        // --- Event Listeners --- 
        function setupEventListeners() {
            // Add hover listeners using event delegation after rows are added
            tableBody.removeEventListener('mouseover', handleRowHover);
            tableBody.addEventListener('mouseover', handleRowHover);

            // Create a debounced version for search input
            const debouncedDisplayData = debounce(displayData, 300); 

            // Search Input Listener
            searchInput.removeEventListener('input', debouncedDisplayData); 
            searchInput.addEventListener('input', debouncedDisplayData);

            // New Clients Filter Listener
            newClientsSelect.removeEventListener('change', displayData); 
            newClientsSelect.addEventListener('change', displayData);

            // Favorites Filter Button Listener
            document.getElementById('favoritesFilterBtn').addEventListener('click', () => {
                 showOnlyFavorites = !showOnlyFavorites;
                 updateFavoritesButton(); // Update button style/text
                 displayData(); // Re-render table with new filter state
            });

            // Listener for preview star (might be redundant if set in updatePreview, but safe)
            const previewStar = document.getElementById('previewStar');
            if (previewStar) {
                // We set onclick in updatePreviewStar to handle changing index
            }
        }

        // Initial setup
        loadFavorites(); // Load favorites first
        loadAndDisplayData();
        setupEventListeners();
    </script>

</body>
</html>
